<div class="calendar-wrapper">
  <!-- Calendar Header -->
  <div class="calendar-header">
    <div class="calendar-nav">
      <button mat-icon-button (click)="previousMonth()" aria-label="Previous month">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <button mat-button (click)="today()" class="today-button">Today</button>
      <button mat-icon-button (click)="nextMonth()" aria-label="Next month">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>
    <h3 class="calendar-title">{{ viewDate | date: 'MMMM yyyy' }}</h3>
  </div>

  <!-- Calendar View -->
  <div class="calendar-container">
    <mwl-calendar-month-view
      [viewDate]="viewDate"
      [events]="events"
      [refresh]="refresh"
      [activeDayIsOpen]="activeDayIsOpen"
      [cellTemplate]="customCellTemplate"
      [openDayEventsTemplate]="customOpenDayTemplate"
      (dayClicked)="dayClicked($event)"
      (eventClicked)="eventClicked($any($event.event))"
      (beforeViewRender)="beforeMonthViewRender($event)">
    </mwl-calendar-month-view>
  </div>

  <!-- Custom cell template to show event titles -->
  <ng-template #customCellTemplate let-day="day" let-locale="locale">
    <div class="cal-cell-top" [class.past-day]="day.isPast">
      <span class="cal-day-number">{{ day.date | date:'d' }}</span>
      @if (day.isPast) {
        <span class="day-x-overlay">&#10005;</span>
      }
    </div>
    <div class="cal-events-container">
      @for (event of day.events; track event) {
        <div
          class="cal-event-chip"
          [class.overdue]="isTaskOverdue($any(event))"
          [style.backgroundColor]="event.color?.primary"
          [style.color]="getTextColor(event.color?.primary)"
          [title]="event.meta?.tooltip"
          (click)="eventClicked($any(event)); $event.stopPropagation()">
          @if (isTaskOverdue($any(event))) {
            <span>&#10071;</span>
            }{{ event.title }}
          </div>
        }
      </div>
    </ng-template>

    <!-- Custom open day events template -->
    <ng-template #customOpenDayTemplate let-events="events" let-isOpen="isOpen">
      @if (isOpen) {
        <div class="open-day-events">
          @for (event of events; track event) {
            <div
              class="open-day-event"
              [style.backgroundColor]="event.color?.primary"
              [style.color]="getTextColor(event.color?.primary)"
              [title]="event.meta?.tooltip"
              (click)="eventClicked($any(event))">
              @if (isTaskOverdue($any(event))) {
                <span>&#10071; </span>
                }{{ event.title }}
              </div>
            }
          </div>
        }
      </ng-template>

      <!-- Legend -->
      <div class="calendar-legend">
        <div class="legend-item">
          <span class="legend-color high"></span>
          <span class="legend-label">High</span>
        </div>
        <div class="legend-item">
          <span class="legend-color medium"></span>
          <span class="legend-label">Medium</span>
        </div>
        <div class="legend-item">
          <span class="legend-color low"></span>
          <span class="legend-label">Low</span>
        </div>
      </div>
    </div>
